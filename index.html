<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Blackjack 23 - Tests</title>

        <!-- Style -->
        <!-- Google Fonts -->
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">

        <!-- CSS Reset -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.css">

        <!-- Milligram CSS minified -->
        <link rel="stylesheet" href="stylesheet/milligram.min.css" />
        <link rel="stylesheet" href="stylesheet/alertify.css" />

        <!-- JS -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-dom.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>

        <style type="text/css">
            #content {
                padding: 30px;
                padding-left: 60px;
            }

            .cards {
                text-align: center;
                width: 100%;
            }

            @keyframes cardAnimation {
                0%   { transform: rotateX(0deg) rotateY(90deg)  rotateZ(0deg); }
                100% { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg); }
            }

            .card {
                animation-name: cardAnimation;
                animation-duration: 0.5s;
                display: inline-block;
            }

            .player-controls {
                text-align: center;
            }

            .player-controls input {
                margin: 5px;
            }
        </style>
    </head>
    <body>
        <div id="content"></div>

        <script>
            window.$ = window.jQuery = require('./javascript/jquery-2.2.1.min.js');
            window.alertify = require('./javascript/alertify.js');

            // Toggle dev tools on F12
            var remote = require('remote');           
            document.addEventListener("keydown", function (e) {  
                if (e.keyCode === 123) { // F12
                    var window = remote.getCurrentWindow();
                    window.toggleDevTools();         
                }
            });
        </script>

        <script type="text/javascript" src="javascript/cards.js" ></script>
        <script type="text/javascript" src="javascript/game.js" ></script>
        <script type="text/babel">

            // Create the game engine
            const deck = new Deck();
            const player = new Player(100);

            const game = new Game(deck, [player]);

            /*
            // Exemple game
            
            console.log("New turn");
            game.nextTurn();

            console.log(game.players[0].hand);

            console.log("Dealer : ");
            console.log(game.dealer.hand);
            console.log(game.dealer.getScore());

            game.playerDraw(0);

            console.log("Hand : ");
            console.log(game.players[0].hand);
            console.log(game.players[0].getScore());

            game.dealerDraw();

            console.log("Dealer : ");
            console.log(game.dealer.hand);
            console.log(game.dealer.getScore());

            console.log(game.endTurn());*/
    

            // Card factory, used to configure how card image are generated
            class CardImageGenerator {
                constructor(image, cardWidth, cardHeight, lineOrder) {
                    this.image = image;
                    this.cardWidth = cardWidth;
                    this.cardHeight = cardHeight;
                    this.lineOrder = lineOrder || cardTypes;
                }

                getImageFor(card) {
                    var xPos = this.lineOrder.indexOf(card.type) * this.cardHeight;
                    var yPos = cardFigures.indexOf(card.figure) * this.cardWidth;

                    var cardStyle = {
                      backgroundImage: 'url(' + this.image + ')',
                      backgroundPosition: '-' + yPos + 'px -' + xPos + 'px',
                      width : this.cardWidth,
                      height : this.cardHeight
                    };

                    return (
                        <div className="card" style={cardStyle} />
                    );
                }
            }
            
            // Image generator for card image
            const cardImageGenerator = new CardImageGenerator('images/cards.jpg', 225, 315, ['heart', 'spade', 'diamond', 'club']);

            // Image of a card, based on a card value, using the card image factory
            var CardImage = React.createClass({
                render: function() {
                    return cardImageGenerator.getImageFor(this.props.card);
                }
            });

            // Hand of card
            var CardHand = React.createClass({
                render: function() {
                    var cardImages = this.props.cards.map((card) => {
                        return (
                            <CardImage card={card} key={card.type + card.figure} />
                        );
                    });

                    return (
                        <div className="cards">
                            {cardImages}
                        </div>
                    );
                }
            });

            // Player zone
            var PlayerZone = React.createClass({
                getInitialState: function() {
                    return { player : this.props.player };
                },

                // Ask for a new card
                hit() {
                    let player = this.state.player;
                    game.playerDraw(0);

                    // Update
                    this.forceUpdate();

                    if(player.isBusted()) {
                        alertify.logPosition("bottom left");
                        alertify.delay(2000);
                        alertify.log("Broken with " + player.getScore());

                        setTimeout(() => {
                            this.stand();
                        }, 2000);
                    }
                },

                // Pass
                stand() {
                    var player = this.state.player;
                    player.stand = true;

                    // Callback
                    this.props.onStand();
                },

                render: function() {
                    const player = this.state.player;

                    if(this.props.type === 'dealer') {
                        var score = player.stand ? player.getScore() : player.hand[0].value;
                        var cards = player.stand ? player.hand : [player.hand[0]];

                        if(score == 1)
                            score = 11;

                        return (
                            <div>
                                <h3>Dealer's cards ({score}) {player.isBusted() ? " - broken !": ""}</h3>
                                <CardHand
                                    className="player-cards column"
                                    cards={cards} />
                            </div>
                        );
                    } else {
                        return (
                            <div>
                                <h3>Player's cards ({player.getScore()}) {player.isBusted() ? " - broken !": ""}</h3>
                                <CardHand
                                    className="player-cards column"
                                    cards={this.state.player.hand} />
                                    <div className="player-controls column">
                                        <input
                                            type="button"
                                            disabled={player.canHit() && !player.stand ? "" : "disabled"}
                                            value="Hit"
                                            onClick={this.hit} />
                                        <input
                                            type="button"
                                            className="button-outline"
                                            disabled={!player.stand ? "" : "disabled"}
                                            value="Stand"
                                            onClick={this.stand}/>
                                    </div>
                            </div>
                        );
                    }
                }
            });
            
            // Blackjack table
            var BlackjackTable = React.createClass({
                getInitialState: function() {
                    // New game
                    return { game : game };
                },

                nextTurn: function() {
                    // Make the dealer draw cards
                    this.state.game.dealerDraw();

                    // End the turn
                    var results = this.state.game.endTurn();

                    // Update
                    this.forceUpdate();

                    // Alert the user
                    alertify.logPosition("bottom left");
                    alertify.delay(2000);
                    if(results[0] == "won") {
                        alertify.log("You won :)");
                    } else if (results[0] == "lost") {
                        alertify.log("You lost :(");
                    } else {
                        alertify.log("Equality :S");
                    }

                    setTimeout(() => {
                        this.state.game.nextTurn();
                        this.forceUpdate();
                    }.bind(this), 2500);
                },

                render: function() {
                    return (
                        <div>
                            <PlayerZone
                                type="dealer"
                                player={this.state.game.dealer} />
                            <PlayerZone
                                type="player"
                                player={this.state.game.players[0]}
                                onStand={() => this.nextTurn()} />
                        </div>
                    );
                }
            });

            // First turn
            game.nextTurn();

            // Test game engine
            ReactDOM.render(
                <div id="container">
                    <BlackjackTable />
                </div>,
                document.getElementById('content')
            );

        </script>
    </body>
</html>